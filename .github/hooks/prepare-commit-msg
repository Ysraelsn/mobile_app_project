#!/usr/bin/env bash

# Archivo: prepare-commit-msg
# FunciÃ³n: Inyecta el nombre de la rama y valida el formato Conventional Commit.
# Este script es ejecutado por Husky.

COMMIT_MSG_FILE="$1"
COMMIT_SOURCE="$2"

# 1. EVITAR EJECUCIÃ“N EN COMMITS AUTOMÃTICOS (MERGE, SQUASH, ETC.)
if [ "$COMMIT_SOURCE" = "merge" ] || [ "$COMMIT_SOURCE" = "squash" ]; then
    exit 0
fi

# 2. OBTENER INFORMACIÃ“N DE LA RAMA
# Obtener nombre de la rama actual (ej: feat/123-login)
BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)

# 3. VALIDACIÃ“N DE CONVENTIONAL COMMIT (Tipo y Longitud)
# Extraer el 'tipo' de commit (ej: feat, fix, chore)
TYPE=$(echo "$BRANCH_NAME" | cut -d'/' -f1)

# Lista de tipos vÃ¡lidos para Conventional Commits
VALID_TYPES="feat|fix|chore|docs|style|refactor|perf|test|ci|build|revert"
if ! echo "$TYPE" | grep -Eq "^($VALID_TYPES)$"; then
	echo "âŒ ERROR: El tipo de commit '$TYPE' extraÃ­do de la rama NO es vÃ¡lido." >&2
	echo "ðŸ‘‰ El formato de rama debe ser: [tipo]/[issue]-[descripciÃ³n]" >&2
	echo "ðŸ‘‰ Tipos vÃ¡lidos: $VALID_TYPES" >&2
	exit 1
fi

# Extraer el nÃºmero de issue si existe
ISSUE=$(echo "$BRANCH_NAME" | grep -oE '^[a-zA-Z]+/([0-9]+)' | cut -d'/' -f2)

# Extraer el 'scope' para el tÃ­tulo
SCOPE=$(echo "$BRANCH_NAME" | cut -d'/' -f2- | sed -E 's/^[0-9]+-//' | cut -d'-' -f1)

# Leer mensaje original
ORIGINAL_MSG=$(cat "$COMMIT_MSG_FILE")

# Construir el tÃ­tulo final (ej: feat(login): mensaje original)
NEW_TITLE="${TYPE}(${SCOPE}): ${ORIGINAL_MSG}"

# Validar longitud del tÃ­tulo (MÃ¡x. 72 caracteres en la primera lÃ­nea)
TITLE_LENGTH=$(echo "$NEW_TITLE" | awk '{print length($0)}')

if [ "$TITLE_LENGTH" -gt 72 ]; then
	echo "âŒ ERROR: El tÃ­tulo excede los 72 caracteres. Es muy largo." >&2
	echo "TÃ­tulo generado: $NEW_TITLE" >&2
	exit 1
fi

# 4. SOBRESCRIBIR EL MENSAJE (INYECCIÃ“N AUTOMÃTICA)
# Usamos parÃ©ntesis para una subshell robusta y forzamos la sobrescritura.
(
    echo "$NEW_TITLE"
    echo # LÃ­nea vacÃ­a
    echo "Branch: $BRANCH_NAME" # Comentario automÃ¡tico
    if [ -n "$ISSUE" ]; then 
        echo "Fixes: #$ISSUE" # Enlaza automÃ¡ticamente al Issue
    fi
) > "$COMMIT_MSG_FILE"

exit 0